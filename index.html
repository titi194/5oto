<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Block-Head Bouncer</title>
    <style>
        /* Basic Page Styling */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
        }

        /* Canvas Styling */
        canvas {
            background-color: #7ab3f1; /* Sky Blue */
            display: block;
        }

        /* Landscape Enforcement for Mobile */
        #rotate-device-message {
            display: none;
            color: white;
            text-align: center;
            font-size: 1.5em;
        }

        @media (orientation: portrait) {
            #gameCanvas {
                display: none;
            }
            #rotate-device-message {
                display: block;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="rotate-device-message">
        <p>Please rotate your device to landscape mode to play.</p>
    </div>

<script>
// ======================================================================================
// GAME SCRIPT - EVERYTHING IS IN HERE!
// ======================================================================================

// --- 1. GET CANVAS AND CONTEXT ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- 2. ASSET LOADER & BASE64 IMAGE STRINGS ---
// --------------------------------------------------------------------------
//  ACTION REQUIRED: Replace these placeholder Base64 strings with your own!
//  Use an online converter to turn your PNG images into Base64 strings.
// --------------------------------------------------------------------------
const ASSETS_BASE64 = {
    // Player Faces
    player_playing: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIBSURBVHhe7dxNatsgEAbgybiwB1gEtqBn8WjYx5I1YkdwBLZgDyag1GgoihGQYm+k5x86I6A7ff0gIl/+1QCAAAECBAgQIECAAIG1BbPZjMlkMpfLZelLnhuMxtnWZ/uX4XAYo9FIrVYrdc1LfoMwCABkMhnevHnT3t5etGkGz/Osrq5OisN4PCbLcq4/jUbjU2iW/j1xTzAQALqun5gXpmn+8I+NRuOQ8Ygmz2w2/wdMAdcTMwx4npdlWRcDAYBaLVaXUilvLBYLC5/d1hBAQcCcSqXyeqVSaavVavvB+/1DqVQiDEPWbDZv2u82EABKJaJpmkbTNNy9e9dcLjeT/W/XarWC4LBYLDabzTt3dAlmAlEUjcFg6Nu8qKZpaDTs2NjYYDDodrtx/fr1+vq6o6wWgGg2m41GowCAcrkcRVEIgpDnmXg8LplMRq/Xj118pFarVSwWY7/fl8vlcDiczWYz4J/JZEImk9Hr9V+4AMwF00kYhpVKhUajIQiCuq4ZDAZFkYDbsG0bRVE6nU4qlXJtGk3TxuNxBEHI5XIymczH4xGGINvtplKpfD6f4vG4rutbWxGA6lCqra1rGkqlUjRNAwBYlnXo88j5JksxMwD1ej1FURiPxzEcbGhoCCCAAkDQNG0xGLzI+kDXdU6nc3Z2dgBgUiwGqFarEAQhqVQaFxcXvb29ubPMAyBAgAABAgQIEAgwJ/kHeXlEKOuYlygAAAAASUVORK5CYII=',
    player_losing: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIcSURBVHhe7dxtctsgEAbgrs4TcoB5kpyQ5B0+K/gBcwI+gCeECm5jH4bCSIuVLAz2O++dhYY/Urv0gwT/KgcIECBAgAABAgQIECBwbQHMZnMyn88/vFwuLe+mNwzD4bJ8vf4YDIao1+u6rt8s+WbPMwwDANM0d3R0xNraWjTL5Pmu0WgUCUfxeJymaRdfKxQKM+AvmAEAGN7hNfHifFkqlUIQBAYDY+l4W6vVal9/MwNcX4wxkEql4HkeAMBisTg5OdmxJ14/BADncrkcDocEgkDUNE0URWVlZbEtv9vXbTabTqdxkGg0ihDGOzIEmACaTqe/tBv0QRAEQVdXdY/HIxaLsVgsSqVSwWAQg09ubtYAIASDQABQKBQiCMNwOPyBCWBsGAbtK/1990MQRKbTaTqdjsVicTicrKurkwQEgFQqRVEUpmmiWCwi3r82Nzfl43K51Gg0IpEISZIkSZLE4/HA88y6rlOpVB6PB13XDz4AmAGaS8IgCBQKBZIkCYKAputyuVxUVavVal3XhRCEOI6l02kiScKybDwel0wmI0kSzP/U6XSi0Wg2mw2CoNraWkDULq11XaNaG/y93m6v40XyBpgpIDwAgiDIZrNFG/xO3zB9hUKBaDTqbrejbJz9fWIAAQ0GgyAIgqIoHA4HU1NTcTycl/oXECBAgAABAgQIEDhcYA4D3uM8HkO9f7UCAAAAQUZ+AfQ0kPqE3+4qAAAAAElFTkSuQmCC',
    player_relaxed: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIQSURBVHhe7dxNatsgEAbgybiwB1gEtqBn8WjYx5I1YkdwBLZgDyag1GgoihGQYm+k5x86I6A7ff0gIl/+1QCAAAECBAgQIECAAIG1BbPZjMlkMpfLZelLnhuMxtnWZ/uX4XAYo9FIrVYrdc1LfoMwCDzPyzTNm5sb/qDNILs9NptNHGexWNQ0TZpmo9HYrKx/8ZpYMAGANAYb9iP89fSfn8fjcZS5MvI8H38ABkAGXJ/MIMDPzw9BEFRVRVCr1R9+yO7xBADgcrn0ej1JJJNJ+Xw+lUphkKRSKeR+P3t/oVarBQGYJEl3S1v7S4IgCIIAgNlsluL4nJqaSiQS6XVlF18AmCEq9fW71l9uX54e1/N8UeD+BGAJBgIAAECSJJqmHR98N3qSJKlarYqihCiKsVjscDiUb7Z5AACKokDX/tYHgBCEWq2WTCZBURRN00RRFBcuLsbjcTQah6IocF0XDAZjPp+TJAkAgM/na3iWk/D588tPAGqF0lqtBggCg8Hg4mO+23FpmiZLssvllpYWJ5MAAEzTRFCqtf4C82m13lqtBEFQKhXAAMiyTCKRBEFQPB5HRw8gAAJaK5VIwiiKSJKk0WhI04KqaZoGABCEsVis1WppNpvwPM887+rq6uHhoS6Xc3t7m6IodR4CBAgQIECAAIFJBT4BF0bEKLV5e2EAAAAASUVORK5CYII=',
    // Obstacle / Item
    poop: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACNSURBVFhH7YxBCsAgDES9/zV7jG7RFNhVOHjRtrQdp5g1iJW/cAXmgBvwQgFQAiYyMAdAAGQyYw0AJmM2gwAgyWRqAYCMZMYaAERmag4ABoAMmTIAAEDWZDoAhAFgwqQBQAowMmeAAIAkyWQAoADIkMkAABagMhlSAJSAmMwIASADMgEcYAXcAUfYAS/gAS73eL1n/2k9AAAAAElFTkSuQmCC',
    mashroom: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADISURBVFhH7ZbBCcAgDEV9/zW7ZJ1iCgxCWDj+dAmGjgkYiK9xBWJQD5SBCbEAAUCETJgrAYBEmU0CgJBIk5kBACSZEfMSgCSZTYKAFJCJcxEAmEiS7wBggEiSWQIAlCSThwCQAJJkhgIAsJBkcgGQAJFkhgUAEEiSmQIABCJLkgEEQEokSWYAIJEkmVEAAIEsyXABAFokSUYOAC2SJLNAAGCQJDMCABSJLKlcAf8y/AM2B0eKxU1Gk23X74e2kXyPkyJJEgS+qWSAuJbCAsaTAmWj7h+zAAAAAElFTkSuQmCC',
    // UI Elements
    heart: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABtSURBVFhH7YxBCoAwDEV7/zV7zKK2+LAh/IUXWc+iT0y0F5dYB+zACbhAAdCDBB5iAQIgIM/g8AAIkCcwgAcAEuT+DB8AgjxzBhIAg8Q3BzcAiCCPA0EAKJH5MzUARCJvBAHIEVgkR5Ie4AEyv74AL9VFnL/iPzAAAAAASUVORK5CYII=',
    btn_long: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAAD9fHfbAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABoSURBVHhe7cixAQAACASg+yft4iCE+EE2gQAeHggQIECAAIGaQMwExAQkHkQE5MUk7QkBAgQIEPgVEBPg1QeM8gJ4/oYECBAgQOD/QEwgpoAsIEtIC8g+ECAAAQL/An++AXf0eC6pAAAAAElFTkSuQmCC',
    btn_pause: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADQAAAAeCAYAAABum6cfAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAA7SURBVFhH7cwxAQAACASg+TfN2okIkU+CBECBAgUKFChQoECBAgUKFChQoECBAgUKFChQwFwDd40AASkYlL4AAAAASUVORK5CYII=',
    btn_jump: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/N6pAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAFRSURBVFhH7dHBTcMwEAVgqjNAO0EbIRslG6QDoANIB7QDRgkM7pBEkRTZ+v3g/gX1+B7r1oAgEolEIpFItiUnX1OanP5TepYxPMMhjuEa5r69MAMzzMOs8/o/5gdmYUYOcy/zzG7MAyzEPMwqjzzPMf1DLOAghnEI3mYkEGAThnHjA7j4GEYxAof5D6YRh/kEzsOEZC7DMCdwg7MYhOEZ9qE81iEN3vEO+zCKwzvspJ/wEA8wjVUEPMw2uIAjeMZT1Gk4g0F0H0M01iEAV2ECvMYl8Ap8wlPchcNYha4j3eEFnMIz/IDzGIEbuIXDWEJ38Ikn4AzGsYLWsYtF7CAOcwXewYV4B8fYRWuYx2yYwhK8gyF8x2MExhE6rB/Q6Lp9yQdYw0vciQkMYRDzGMx3kQjHMBzBMQwiQOIQEwEEIgSRAUQmEAkkEonEG/IDQd/c8uKkNKsAAAAASUVORK5CYII=',
    icon_sound_on: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEySURBVFhH7Y/BDoIwDEV5/zW7jZt11Yxpm+ALb+VpsQkKjfC1JMSLw4F+CqCBAugjAQQpAQQJQAKTEkAECEoCDAIkBfCTnQAIKEgKEEQAKMGAhICuEEAIyOQnAJoFpADpAEAJCchSAIAsD38CYBcgDVAHwJI4DUBT4JUAaAO8KkBaAEtKAIhOQEKA5CSAkRAwBQCZkCQA1iUgE/JMAEjEFAJCdgJyISAnAEQiISBWBEQCZCJCElQhAGQiIQFaYjSA05B/AehhHqCA9sCQAEDtAB552dYDgN0AHgMwC0AjgO4ANAF2AbADkH1pAY0AbQOaAQwC9kCQA6wPQLgXyDqAx8u0k9HSc+C5P88lW8Psvy15vH6c9X6oV6q9kLRLVAG/AWFqj7hI0+K8AAAAAElFTkSuQmCC',
    icon_sound_off: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAErSURBVFhH7Y+hDsJAEETP/k/rLNYkGxfxGf/hXXM6lSKNQrjViQgvzgP6LYAGEaCPAkCSAUkGIMGoBBABgsZAYAAiYz+JkQBIGRkDKAIApGkYGSAdAUAJpGWVAEAyC5EAMAugBpIBgHkcQoCMAkAE+EpAKQBfWwGIALAUACATGRkgGgFJYwEkQgIFADIpE/JnEkAikDCAVAo5ETJIAIjERAIIgYAcBQghABkJ8AoEBCBEQiISJCIpERCSLQiAk4hISIgWEEI4R/6P93M1EIDyB5ICqAMAB9+eOACc6QCeAFkA2gDkAFwFUA9AKYA0AVQC7AZQB3B6oM0Anl1DDoCOAWwDoAsAP4CGAZMBhAWMBgy4JgJ2AT5fph1ZJ2b5k8z12X/Lkn3j+LTrj9frDaqnqqxZVQB7v5u/zJ4fEQAAAABJRU5ErkJggg==',
    // Environment
    ground_tile: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADvSURBVHhe7dBBCoAwDEXBD93/tHKT9hAh9tJBB053p5E73fF1A3z+Tz/AK/CFkGfAZ+DjwO5gI5jQZkYJECBAgAABAlECn5zQpiHlHwgQIECAAAECUYJ+LmgTUDCkygMECBAgQIDAhEC7LmhjUNYDAgQIECAwIVB10AagK+fQhggBAgQIECDw/0DPaBsE5KSAe+vL9gECBAgQIJAgsHkSDAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAIELgR2Ww9nAQ7bDAwQIECBwrgQ+AQ7dY8zEpHkAAAAASUVORK5CYII=',
    dirt_tile: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAC0SURBVHhe7dHBDYAgDEPRrTfoqP9g3Q0SJKUINm4z3N7jZwCysgX/876c8AJY4LSEjwnYCRwjF9wECBAgQICAbEBaHjAnQIwAAQIECBDwn0BjBcgCgh8IxoY/kAYIECBAgMBdgdIE3AnqPZAYIECAAIFfAqUTcAfoa4EEBAgQIECgnwLtBIq2L+8b/QkECBAgQOBfgcQE6vCqAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIXAjsiP4B/Z6bAFAwA3gAAAABJRU5ErkJggg==',
    rock_obstacle: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEKSURBVFhH7ZYxDoMwEEY992vtj14d8xI8iT2l7Y54gEgoaIok2zZpP3bWlzaR3Q7gB+4AFtABD8hI4ARQAmIgEzh/AAKAmEzhBSDAj8zkAyC4M5n7AcSbyQCA0M1kJUDIbyYHAEAykw4AodxkAsDId5MNABGfyQCACW4yAOAEs5lBAIAz+u012Lp9h+2hI+CjBPCgBPCnZzSAvwSAH79HBHgiYfC6R24L4EnW2zUBOpE1d40A3kSNDRkBEF3j0REAnp+u2Y2AAz9lH04a4M/9/t4H8ONH9ABvH1Hh5g0Arb4zIgfAEWc0HAAcEUYDAOc9MxgBuHdoMgAAvp1/AYz+fX9b/OejAAAAAElFTkSuQmCC',
    cloud: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAsCAYAAAD9b1GZAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMNSURBVHhe7ZvPcuJAEEbfdI6s0wFygHWC0mRchSdwChyn4LgCwwkYgROwdALqJKhD51R2iOAIzUhkZ2ePNDPzyjOq1w9P9y0W25m+t1KpFKtZzW/p7J+f24fdbge/v6l+f2l+yV3LdDrNc8vleOPl25/f7LpQKPxOa2jH+Pnz51KpbGVy219bW7G1tfVfX1e/n0qlqul0ejT3c9Uf/X4Xo1fR43w2m/0k0+cKgcw/n2i1+utjWJ+P+J9V8WcQWADw+vXrT5o/hBAmK1l8oQKAIAhhP+rPz8/b4qK+9wKAx+PZ1NSUQ3o30lqfzzC5lsvl0qg6tQj3Y2u21/3rXWCM1p7P5ysUCsUaG/D5vDxf29vbg9kMhmwzAAzG1lqtlvL9vby8+Prrr1+/flWrVWt5OzwIgwG7/R9/k7wM4e0bOAAIhMfjy7qVTCYr2/6KAGgTCoXC6+vryyYmJoYsN7gQACqVIpvNLssbH7nS9cMAqFAoNDU15dCeMZnMjWwW3q/eG2FmI6s4n89b2VwXAJgWdYQAiBAy9Bwz2TAYhBkAms1mk/9jGAybqGq1GoD2WADyIqFQKAD6G9fV1dVkMrkx3oU7WADq7GwyefnyZZWjY9MIAgG+2o3L/75QKLxtGgQAABKJoMFo0AAYhBCdAI/Hg/P9mK+DweA3w4MAwN3dHWApEAjs81eI2Vrr9RpxM0S1AODt7Y3NZoNtXo8XACsAYH8MgyFCwBhTazA3NzftCACAq1evAmjfAIAqAOBiAwBMBADQvAGAKgBgYyMAXAWA6zIuE9lX/r4gG58Qy17AQQBQXc9N7XNza14fAFAzUjGzAgDoAgDgQADAyACAkA0AoAwAnWnBzw8AAFgDDAAo6V/JAAClBQBoEADY/gEAaAIA7AQArACACgBoBgD2AsB/AwBWAP8aAPwfAIu/+wQASZKUyWTK3sEvy09K9y97B7MA/xP0WnLq0+u+lAAAAABJRU5ErkJggg==',
};
const assets = {};

function loadAssets(callback) {
    let assetsLoaded = 0;
    const totalAssets = Object.keys(ASSETS_BASE64).length;

    if (totalAssets === 0) {
        callback();
        return;
    }

    for (let key in ASSETS_BASE64) {
        assets[key] = new Image();
        assets[key].src = ASSETS_BASE64[key];
        assets[key].onload = () => {
            assetsLoaded++;
            if (assetsLoaded === totalAssets) {
                callback();
            }
        };
    }
}


// --- 3. GAME CONFIGURATION AND STATE ---
const config = {
    // Canvas dimensions
    width: 800,
    height: 450,
    // Player settings
    playerSpeed: 3,
    jumpForce: 13,
    gravity: 0.6,
    // Score
    scorePerSecond: 10,
    poopPenalty: 250,
    mushroomBonus: 500,
};

let gameState = 'MENU'; // 'MENU', 'PLAYING', 'PAUSED', 'GAMEOVER'
let score = 0;
let highScore = localStorage.getItem('blockHeadHighScore') || 0;
let soundOn = true;
let isMouseDown = false;
let mousePos = { x: 0, y: 0 };


// --- 4. GAME OBJECTS (PLAYER, PLATFORMS, etc.) ---

// Camera object to follow the player
const camera = {
    x: 0,
    y: 0,
    update: function(target) {
        // Follow the player, but don't go backwards
        if (target.x - this.x > 300) {
            this.x = target.x - 300;
        }
    }
};

// Player object
let player = {};
function resetPlayer() {
    player = {
        x: 100,
        y: 100,
        vx: 0,
        vy: 0,
        width: 48,
        height: 48,
        isGrounded: false,
        health: 3,
        faceState: 'playing', // 'playing', 'losing', 'relaxed'
        faceTimer: 0,
    };
}

// World objects (platforms, items)
let platforms = [];
let items = [];
let obstacles = [];
let clouds = [];

function generateLevel() {
    platforms = [
        // Starting platform
        { x: 0, y: 380, width: 600, height: 70 },
        // Subsequent platforms
        { x: 750, y: 380, width: 400, height: 70 },
        { x: 900, y: 250, width: 150, height: 70 },
        { x: 1300, y: 380, width: 150, height: 70 },
        { x: 1600, y: 320, width: 300, height: 70 },
        { x: 2000, y: 250, width: 200, height: 70 },
        { x: 2350, y: 380, width: 800, height: 70 },
        { x: 3300, y: 380, width: 400, height: 70 },
        { x: 3400, y: 250, width: 100, height: 70 },
        // Add more platforms...
    ];

    items = [
        { x: 850, y: 350, type: 'mashroom', width: 32, height: 32 },
        { x: 2500, y: 350, type: 'mashroom', width: 32, height: 32 },
    ];

    obstacles = [
        // Poop
        { x: 400, y: 350, type: 'poop', width: 32, height: 32 },
        { x: 1750, y: 290, type: 'poop', width: 32, height: 32 },
        { x: 2700, y: 350, type: 'poop', width: 32, height: 32 },
        { x: 2800, y: 350, type: 'poop', width: 32, height: 32 },
        // Rocks (static obstacles, not collected)
        { x: 950, y: 350, type: 'rock_obstacle', width: 32, height: 32 },
    ];
    
    // Generate some clouds for parallax effect
    clouds = [];
    for(let i=0; i < 15; i++) {
        clouds.push({
            x: Math.random() * 4000, // Spread clouds across the level
            y: Math.random() * 150,
            scale: 0.5 + Math.random() * 0.5, // Random size
            speed: 0.1 + Math.random() * 0.2 // Random speed
        });
    }
}

// UI button definitions
const uiButtons = {
    // Menu screen
    start:       { x: config.width / 2 - 96, y: 150, w: 192, h: 48, asset: assets.btn_long, text: 'START' },
    highScore:   { x: config.width / 2 - 96, y: 220, w: 192, h: 48, asset: assets.btn_long, text: 'HIGH SCORE' },
    // Gameplay screen
    jump:        { x: config.width - 150,    y: config.height - 150, w: 92, h: 92, asset: assets.btn_jump, text: 'JUMP' },
    pause:       { x: config.width - 120,    y: 20, w: 100, h: 32, asset: assets.btn_pause, text: 'PAUSE' },
    sound:       { x: config.width - 50,     y: 80, w: 32, h: 32 },
    // Paused/Game Over screen
    resume:      { x: config.width / 2 - 96, y: 150, w: 192, h: 48, asset: assets.btn_long, text: 'RESUME' },
    restart:     { x: config.width / 2 - 96, y: 150, w: 192, h: 48, asset: assets.btn_long, text: 'RESTART' },
    menu:        { x: config.width / 2 - 96, y: 220, w: 192, h: 48, asset: assets.btn_long, text: 'MENU' }
};


// --- 5. GAME LOGIC & UPDATES ---
function update(dt) {
    if (gameState !== 'PLAYING') return;

    // --- Update Player ---
    // Horizontal movement (auto-runner)
    player.vx = config.playerSpeed;
    player.x += player.vx;
    
    // Vertical movement (gravity)
    player.vy += config.gravity;
    player.y += player.vy;
    player.isGrounded = false;
    
    // Collision with platforms
    platforms.forEach(p => {
        if (player.x + player.width > p.x &&
            player.x < p.x + p.width &&
            player.y + player.height > p.y &&
            player.y < p.y + p.height) 
        {
            // If falling onto a platform
            if (player.vy > 0 && (player.y + player.height - player.vy) <= p.y) {
                 player.y = p.y - player.height;
                 player.vy = 0;
                 player.isGrounded = true;
            }
        }
    });
    
    // Collision with items
    items.forEach((item, index) => {
        if (player.x < item.x + item.width && player.x + player.width > item.x &&
            player.y < item.y + item.height && player.y + player.height > item.y)
        {
            // Collect mashroom
            if (item.type === 'mashroom') {
                player.faceState = 'relaxed';
                player.faceTimer = 3; // Face changes for 3 seconds
                score += config.mushroomBonus;
                // play sound: playSound('powerup');
            }
            items.splice(index, 1);
        }
    });
    
    // Collision with obstacles
    obstacles.forEach((obstacle, index) => {
        if (obstacle.type === 'poop' &&
            player.x < obstacle.x + obstacle.width && player.x + player.width > obstacle.x &&
            player.y < obstacle.y + obstacle.height && player.y + player.height > obstacle.y)
        {
            // Take damage from poop
            player.health--;
            score -= config.poopPenalty;
            if (score < 0) score = 0;
            player.faceState = 'losing';
            player.faceTimer = 0.5; // "Mad" face flashes for 0.5 seconds
            // play sound: playSound('damage');
            obstacles.splice(index, 1); // Remove the poop
            if (player.health <= 0) {
                gameOver();
            }
        }
    });

    // Face state timer
    if (player.faceTimer > 0) {
        player.faceTimer -= dt;
        if (player.faceTimer <= 0) {
            player.faceState = 'playing';
            player.faceTimer = 0;
        }
    }
    
    // Check for falling off-screen
    if (player.y > config.height) {
        gameOver();
    }
    
    // Update score
    score += config.scorePerSecond * dt;

    // Update camera
    camera.update(player);
}

// --- 6. RENDERING (DRAWING TO CANVAS) ---
function draw() {
    // Clear canvas
    ctx.clearRect(0, 0, config.width, config.height);

    // Draw parallax background
    ctx.save();
    // Sky
    ctx.fillStyle = '#7ab3f1';
    ctx.fillRect(0,0,config.width, config.height);
    // Clouds
    clouds.forEach(cloud => {
        const cloudX = (cloud.x - camera.x * cloud.speed) % (config.width + 200) - 100; // Looping clouds
        const cloudW = assets.cloud.width * cloud.scale;
        const cloudH = assets.cloud.height * cloud.scale;
        ctx.drawImage(assets.cloud, cloudX, cloud.y, cloudW, cloudH);
    });
    ctx.restore();


    // Translate canvas for camera
    ctx.save();
    ctx.translate(-camera.x, 0);

    // --- Draw Game World ---
    // Platforms
    platforms.forEach(p => {
        const pattern = ctx.createPattern(assets.dirt_tile, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(p.x, p.y + 10, p.width, p.height-10);
        
        const topPattern = ctx.createPattern(assets.ground_tile, 'repeat');
        ctx.fillStyle = topPattern;
        ctx.fillRect(p.x, p.y, p.width, 16);
    });
    // Items and Obstacles
    [...items, ...obstacles].forEach(obj => {
        if (assets[obj.type]) {
             ctx.drawImage(assets[obj.type], obj.x, obj.y, obj.width, obj.height);
        }
    });
    
    // Player
    let playerFace;
    switch (player.faceState) {
        case 'losing': playerFace = assets.player_losing; break;
        case 'relaxed': playerFace = assets.player_relaxed; break;
        default: playerFace = assets.player_playing;
    }
    if (playerFace) {
        ctx.drawImage(playerFace, player.x, player.y, player.width, player.height);
    }
    
    ctx.restore(); // Restore canvas from camera translation

    // --- Draw UI ---
    switch(gameState) {
        case 'MENU':
            drawOverlay();
            drawButton(uiButtons.start);
            drawButton(uiButtons.highScore);
            ctx.fillStyle = 'white';
            ctx.font = "32px 'Courier New', monospace";
            ctx.textAlign = 'center';
            ctx.fillText(`High Score: ${Math.floor(highScore)}`, config.width / 2, 320);
            break;
        case 'PLAYING':
            drawHUD();
            drawButton(uiButtons.jump);
            drawButton(uiButtons.pause);
            drawButton(uiButtons.sound);
            break;
        case 'PAUSED':
            drawHUD(); // Show game state underneath
            drawOverlay();
            drawButton(uiButtons.resume);
            drawButton(uiButtons.menu);
            break;
        case 'GAMEOVER':
            drawHUD();
            drawOverlay();
            drawButton(uiButtons.restart);
            drawButton(uiButtons.menu);
            ctx.fillStyle = 'white';
            ctx.font = "bold 48px 'Courier New', monospace";
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', config.width / 2, 110);
            if(score > highScore) {
                 ctx.font = "24px 'Courier New', monospace";
                 ctx.fillText('New High Score!', config.width / 2, 320);
            }
            break;
    }
}

function drawHUD() {
    // Health
    for(let i = 0; i < player.health; i++) {
        ctx.drawImage(assets.heart, 20 + i * 40, 20, 32, 32);
    }
    // Score
    ctx.fillStyle = 'white';
    ctx.font = "24px 'Courier New', monospace";
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${Math.floor(score)}`, 20, 70);
}

function drawOverlay() {
    ctx.fillStyle = 'rgba(110, 85, 61, 0.7)'; // Brownish overlay
    ctx.fillRect(0, 0, config.width, config.height);
}

function drawButton(btn) {
    if(btn.asset) {
        ctx.drawImage(btn.asset, btn.x, btn.y, btn.w, btn.h);
    }
    // Specific drawing for sound icon
    if(btn === uiButtons.sound) {
        const soundIcon = soundOn ? assets.icon_sound_on : assets.icon_sound_off;
        if(soundIcon) ctx.drawImage(soundIcon, btn.x, btn.y, btn.w, btn.h);
        return;
    }
    
    if(btn.text === 'JUMP') {
        ctx.fillStyle = 'black';
        ctx.font = "bold 20px 'Courier New', monospace";
        ctx.textAlign = 'center';
        ctx.fillText('JUMP', btn.x + btn.w / 2, btn.y + btn.h/2 - 10);
        ctx.font = "14px 'Courier New', monospace";
        ctx.fillText('Button', btn.x + btn.w / 2, btn.y + btn.h/2 + 10);
        return;
    }
    
    if (btn.text) {
        ctx.fillStyle = 'black';
        ctx.font = "bold 24px 'Courier New', monospace";
        ctx.textAlign = 'center';
        ctx.fillText(btn.text, btn.x + btn.w / 2, btn.y + btn.h / 2 + 8);
    }
}

// --- 7. GAME STATE MANAGEMENT ---
function resetGame() {
    score = 0;
    camera.x = 0;
    resetPlayer();
    generateLevel();
}

function startGame() {
    resetGame();
    gameState = 'PLAYING';
}

function gameOver() {
    // playSound('gameover');
    gameState = 'GAMEOVER';
    if(score > highScore) {
        highScore = score;
        localStorage.setItem('blockHeadHighScore', highScore);
    }
}


// --- 8. INPUT HANDLING ---
function handleInput(x, y) {
    function isInside(pos, rect) {
        return pos.x > rect.x && pos.x < rect.x + rect.w && pos.y > rect.y && pos.y < rect.y + rect.h;
    }

    if(gameState === 'PLAYING') {
        if(isInside({x,y}, uiButtons.jump)) {
            if(player.isGrounded) {
                player.vy = -config.jumpForce;
                // playSound('jump');
            }
        }
        if(isInside({x,y}, uiButtons.pause)) {
            gameState = 'PAUSED';
            // playSound('pause');
        }
        if(isInside({x,y}, uiButtons.sound)) {
            soundOn = !soundOn;
        }
    } else if (gameState === 'PAUSED') {
         if(isInside({x,y}, uiButtons.resume)) {
            gameState = 'PLAYING';
        }
        if(isInside({x,y}, uiButtons.menu)) {
            gameState = 'MENU';
        }
    } else if (gameState === 'MENU') {
        if(isInside({x,y}, uiButtons.start)) {
            startGame();
        }
    } else if (gameState === 'GAMEOVER') {
         if(isInside({x,y}, uiButtons.restart)) {
            startGame();
        }
        if(isInside({x,y}, uiButtons.menu)) {
            gameState = 'MENU';
        }
    }
}

function setupInputListeners() {
    function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (evt.clientX - rect.left) / rect.width * config.width,
            y: (evt.clientY - rect.top) / rect.height * config.height
        };
    }
    
    // Mouse Events
    canvas.addEventListener('mousedown', (e) => {
        isMouseDown = true;
        const pos = getMousePos(canvas, e);
        handleInput(pos.x, pos.y);
    });
    
    // Touch Events for Mobile
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isMouseDown = true;
        const touch = e.touches[0];
        const pos = getMousePos(canvas, touch);
        handleInput(pos.x, pos.y);
    }, false);
}


// --- 9. MAIN GAME LOOP ---
let lastTime = 0;
function gameLoop(timestamp) {
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;
    
    if(gameState === 'PLAYING') {
      update(dt);
    }
    
    draw();

    requestAnimationFrame(gameLoop);
}


// --- 10. INITIALIZATION ---
function init() {
    // Resize canvas
    canvas.width = config.width;
    canvas.height = config.height;
    
    // Set initial objects
    resetPlayer();
    generateLevel();
    
    // Set up listeners
    setupInputListeners();
    
    // Start the game loop
    console.log("Game assets loaded. Starting game loop.");
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
}

// Wait for all assets to load, then start the game.
loadAssets(init);

</script>

</body>
</html>
